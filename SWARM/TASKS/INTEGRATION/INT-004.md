# Task: INT-004

## Metadata
- **Lane**: INTEGRATION
- **Type**: FIX_ONE_BUG
- **Severity**: MEDIUM
- **Status**: PENDING
- **Created**: 2026-01-15T00:00:00Z

## Context Pack

### Current Implementation (swarm.py lines 16-18)
```python
def save_state(state):
    state["last_updated"] = datetime.now().isoformat()
    with open(STATE_FILE, 'w') as f:
        json.dump(state, f, indent=2)
```

### Problem
The `save_state()` function writes JSON directly to STATE_FILE without using atomic write operations. This creates a race condition where:
- If the process crashes during write, the file could be corrupted or partially written
- Multiple concurrent writes could create an inconsistent state file
- No recovery mechanism for failed writes

### Files to modify (ONLY these)
- /home/ubuntu/projects/zerg-swarm/SWARM/SCRIPTS/swarm.py

## Objective
Replace the direct file write with an atomic temp file + rename pattern to ensure STATE_FILE is never in an inconsistent state during writes.

## Deliverables
- [ ] Implement atomic write using tempfile module (write to .tmp file first)
- [ ] Use os.replace() for atomic rename operation
- [ ] Update save_state() function with try/except error handling
- [ ] Verify atomic write with check command (see below)

## Technical Requirements

### Implementation Pattern
1. Create temporary file in same directory as STATE_FILE (for same filesystem)
2. Write JSON to temporary file with explicit flush
3. Use os.replace() for atomic rename (cross-platform safe)
4. Handle exceptions: FileNotFoundError, PermissionError, IOError

### Code Structure
```python
def save_state(state):
    state["last_updated"] = datetime.now().isoformat()
    try:
        # Write to temporary file
        temp_file = STATE_FILE.with_suffix('.tmp')
        with open(temp_file, 'w') as f:
            json.dump(state, f, indent=2)
        # Atomic rename
        temp_file.replace(STATE_FILE)
    except (FileNotFoundError, PermissionError, IOError) as e:
        print(f"Error saving state: {e}", file=sys.stderr)
        raise
```

## Verification Command
```bash
# Test atomic write behavior
python3 -c "
from pathlib import Path
import sys
import json
sys.path.insert(0, '/home/ubuntu/projects/zerg-swarm/SWARM/SCRIPTS')
from swarm import save_state, load_state

# Write test state
test_state = {'wave': 5, 'active_zerglings': ['Z1', 'Z2'], 'completed_tasks': []}
save_state(test_state)

# Verify no .tmp file remains
tmp_file = Path('/home/ubuntu/projects/zerg-swarm/SWARM/STATE.tmp')
assert not tmp_file.exists(), 'Temp file should not exist after atomic write'

# Verify state was written correctly
loaded = load_state()
assert loaded['wave'] == 5, 'Wave should be 5'
assert 'Z1' in loaded['active_zerglings'], 'Z1 should be in active zerglings'

print('âœ“ Atomic file operations verified')
"
```

## Constraints
- Max 30 lines of code change
- No new dependencies (tempfile and os are stdlib)
- Must maintain backward compatibility
- Must preserve existing behavior for concurrent read access

## Acceptance Criteria
- [ ] save_state() uses atomic write pattern
- [ ] No .tmp files left behind after successful writes
- [ ] Verification command passes without errors
- [ ] Error handling added for file operation failures
- [ ] Code change < 30 lines

## Result
(To be filled by assigned Zergling)
