# Task: INT-008

## Metadata
| Field | Value |
|-------|-------|
| Lane | INTEGRATION |
| Type | ADD_PURE_FN |
| Wave | - |
| Status | PENDING |
| Created | 2026-01-15 |
| Assigned | - |

## Context Pack

### Files
- /home/ubuntu/projects/zerg-swarm/SWARM/STATE.json
- /home/ubuntu/projects/zerg-swarm/SWARM/SCRIPTS/swarm.py
- /home/ubuntu/projects/zerg-swarm/SWARM/TASKS/
- /home/ubuntu/projects/zerg-swarm/SWARM/OUTBOX/

### Current STATE.json Structure
```json
{
  "wave": 0,
  "active_zerglings": [],
  "completed_tasks": [],
  "pending_tasks": [
    "KERNEL/K001",
    "KERNEL/K002",
    "KERNEL/K003",
    "ML/M001",
    "ML/M002",
    "ML/M003",
    "QUANT/Q001",
    "QUANT/Q002",
    "QUANT/Q003",
    "DEX/D001",
    "DEX/D002",
    "DEX/D003"
  ],
  "last_updated": "2026-01-15T20:15:00Z"
}
```

### Problem: State Drift
The `pending_tasks` list in STATE.json can desynchronize from actual task files in:
- SWARM/TASKS/<LANE>/<ID>.md (source of truth)
- SWARM/OUTBOX/*.md (assigned tasks)

This creates data integrity issues when:
1. Task files are deleted manually without updating STATE.json
2. New task files are created but not reflected in pending_tasks
3. Tasks are moved between directories without state updates
4. Wave transitions occur with stale pending_tasks references

### Target Flaw
MEDIUM severity: State drift - pending_tasks in STATE.json can desync from actual OUTBOX/TASKS files

## Objective
Add a `cmd_reconcile()` function to swarm.py that:
1. Scans SWARM/TASKS/<LANE>/ for all task files (*.md, excluding README.md)
2. Scans SWARM/OUTBOX/ for currently assigned tasks
3. Compares actual files against pending_tasks in STATE.json
4. Reports differences and inconsistencies
5. Offers to update STATE.json to match actual files

## Deliverables
- [ ] Implement `scan_tasks_directory()` helper
  - Recursively scan SWARM/TASKS/
  - Extract task IDs in format LANE/ID
  - Return set of all found task IDs
- [ ] Implement `scan_outbox_directory()` helper
  - Scan SWARM/OUTBOX/
  - Return set of assigned task IDs
- [ ] Implement `cmd_reconcile()` function
  - Compare STATE.json pending_tasks with actual files
  - Detect missing tasks (in STATE but not in files)
  - Detect orphaned tasks (in files but not in STATE)
  - Detect incorrectly assigned tasks (in OUTBOX but not in STATE)
  - Report summary with diffs
  - Optional: update pending_tasks to match files with --fix flag
- [ ] Add cmd_reconcile to main() command dispatcher
- [ ] Return zero on success, nonzero on conflicts

## Acceptance Criteria (INTEGRATION Gate)
- [ ] Wire test: `swarm.py reconcile` runs without errors
- [ ] Reconcile correctly identifies drift between pending_tasks and actual files
- [ ] Reconcile report clearly shows:
  - Tasks in STATE but missing from files
  - Tasks in files but missing from STATE
  - Tasks in OUTBOX not in STATE
- [ ] Optional --fix flag updates STATE.json safely
- [ ] Output format is machine-parseable (JSON option)

## Example Output
```
=== RECONCILIATION REPORT ===
Status: DRIFT DETECTED

Pending Tasks (STATE): 12
Actual Task Files: 12
Assigned (OUTBOX): 0

Inconsistencies:
  - KERNEL/K001: OK
  - KERNEL/K002: OK
  - ML/M001: MISSING (file not found)
  - ML/M004: ORPHANED (file exists, not in STATE)

Summary:
  Missing: 1 task
  Orphaned: 1 task
  Conflicts: 0

Use --fix to update STATE.json to match actual files.
```

## Constraints
- Max 150 lines of new code
- No external dependencies (use only stdlib)
- Pure function: no side effects unless --fix flag used
- Must handle missing directories gracefully

## Notes
- This task is critical for wave transitions and data integrity
- Reconciliation should run before wave increments (cmd_new_wave)
- Consider adding auto-reconcile to cmd_collect() for safety
- Task ID format: LANE/ID where LANE is directory name and ID is file stem
