# INT-002: Add Error Handling to swarm.py

**Lane**: INTEGRATION  
**Type**: FIX_ONE_BUG  
**Priority**: CRITICAL  
**Status**: PENDING  
**Created**: 2026-01-15

---

## Problem Statement

The swarm.py file has three critical gaps in error handling that could cause silent failures and security vulnerabilities:

1. **Missing file operations error handling** - Lines 15-16, 20-21
2. **JSON parsing vulnerability** - No validation after json.load()
3. **Incomplete state validation** - load_state() doesn't validate required keys

---

## Context Pack: Current Code (Lines 12-25)

```python
SWARM_ROOT = Path(__file__).parent.parent
STATE_FILE = SWARM_ROOT / "STATE.json"
OUTBOX_DIR = SWARM_ROOT / "OUTBOX"
INBOX_DIR = SWARM_ROOT / "INBOX"

def load_state():
    if not STATE_FILE.exists():
        return {"wave": 0, "active_zerglings": [], "completed_tasks": [], "pending_tasks": [], "last_updated": datetime.now().isoformat()}
    with open(STATE_FILE) as f:
        return json.load(f)

def save_state(state):
    state["last_updated"] = datetime.now().isoformat()
    with open(STATE_FILE, 'w') as f:
        json.dump(state, f, indent=2)
```

---

## Critical Flaws Identified

### Flaw 1: Unhandled File Read Exception (Line 15)
```python
with open(STATE_FILE) as f:
    return json.load(f)
```
**Risk**: File may not be readable due to permissions, disk errors, or concurrent access  
**Impact**: Script crashes silently without user feedback

### Flaw 2: JSON Parsing Vulnerability (Line 16)
```python
return json.load(f)
```
**Risk**: Corrupted or malformed JSON file will cause JSONDecodeError  
**Impact**: Swarm state corrupted; state cannot be recovered

### Flaw 3: Missing State Validation (Line 16)
After json.load(), no verification that required keys exist (wave, active_zerglings, etc.)  
**Risk**: Missing keys cause KeyError in cmd_status() and other functions  
**Impact**: Downstream commands fail when accessing state['wave'], state['active_zerglings'], etc.

### Flaw 4: Unhandled File Write Exception (Line 21)
```python
with open(STATE_FILE, 'w') as f:
    json.dump(state, f, indent=2)
```
**Risk**: Write permissions denied, disk full, or concurrent access  
**Impact**: State changes silently lost; swarm progress untracked

---

## Deliverables

### D1: Wrap json.load() in try-except block
- Catch `json.JSONDecodeError` with informative error message
- Return default state if JSON is corrupted
- Log the corruption for debugging

### D2: Add state validation after load
- Validate presence of required keys: `wave`, `active_zerglings`, `completed_tasks`, `pending_tasks`, `last_updated`
- Merge with default state to fill missing keys
- Ensure all callers receive consistent state structure

### D3: Wrap json.dump() in try-except block
- Catch `IOError` and `OSError` for file write failures
- Provide user feedback on write failures
- Prevent silent loss of state changes

### D4: Add informative error messages
- Include file path and error details
- Suggest remediation (e.g., "Check file permissions" or "Delete corrupted STATE.json")

---

## Implementation Requirements

### Required Changes to load_state()

```python
def load_state():
    if not STATE_FILE.exists():
        return {
            "wave": 0,
            "active_zerglings": [],
            "completed_tasks": [],
            "pending_tasks": [],
            "last_updated": datetime.now().isoformat()
        }
    
    try:
        with open(STATE_FILE) as f:
            state = json.load(f)
    except json.JSONDecodeError as e:
        print(f"ERROR: Corrupted STATE.json ({STATE_FILE})", file=sys.stderr)
        print(f"  Details: {e}", file=sys.stderr)
        print(f"  Recovery: Delete the file and restart swarm", file=sys.stderr)
        # Return default state instead of crashing
        return {
            "wave": 0,
            "active_zerglings": [],
            "completed_tasks": [],
            "pending_tasks": [],
            "last_updated": datetime.now().isoformat()
        }
    except (IOError, OSError) as e:
        print(f"ERROR: Cannot read STATE.json ({STATE_FILE})", file=sys.stderr)
        print(f"  Details: {e}", file=sys.stderr)
        print(f"  Recovery: Check file permissions", file=sys.stderr)
        return {
            "wave": 0,
            "active_zerglings": [],
            "completed_tasks": [],
            "pending_tasks": [],
            "last_updated": datetime.now().isoformat()
        }
    
    # Validate state has required keys
    required_keys = {"wave", "active_zerglings", "completed_tasks", "pending_tasks", "last_updated"}
    if not isinstance(state, dict):
        print(f"ERROR: STATE.json is not a dictionary", file=sys.stderr)
        state = {}
    
    for key in required_keys:
        if key not in state:
            print(f"WARNING: STATE.json missing '{key}' key, using default", file=sys.stderr)
            if key == "wave":
                state[key] = 0
            elif key == "last_updated":
                state[key] = datetime.now().isoformat()
            else:
                state[key] = []
    
    return state
```

### Required Changes to save_state()

```python
def save_state(state):
    state["last_updated"] = datetime.now().isoformat()
    try:
        with open(STATE_FILE, 'w') as f:
            json.dump(state, f, indent=2)
    except (IOError, OSError) as e:
        print(f"ERROR: Cannot write STATE.json ({STATE_FILE})", file=sys.stderr)
        print(f"  Details: {e}", file=sys.stderr)
        print(f"  Recovery: Check disk space and file permissions", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"ERROR: Unexpected error writing STATE.json: {e}", file=sys.stderr)
        sys.exit(1)
```

---

## Verification Command

Run these commands to verify error handling:

```bash
# Test 1: Corrupt STATE.json and verify recovery
cd /home/ubuntu/projects/zerg-swarm/SWARM
echo "INVALID JSON {" > STATE.json
python3 SCRIPTS/swarm.py status
# Expected: Error message + default state displayed

# Test 2: Delete STATE.json and verify creation
rm -f STATE.json
python3 SCRIPTS/swarm.py status
# Expected: Default state displayed, STATE.json recreated

# Test 3: Normal operation
python3 SCRIPTS/swarm.py wave
python3 SCRIPTS/swarm.py status
# Expected: Wave incremented successfully, no errors
```

---

## Acceptance Criteria

- [ ] All file operations wrapped in try-except blocks
- [ ] json.JSONDecodeError caught and handled gracefully
- [ ] State validation performed on load; missing keys replaced with defaults
- [ ] Error messages include file paths and remediation suggestions
- [ ] Swarm script continues operation even with corrupted state
- [ ] All verification tests pass without crashing
- [ ] Code follows existing style (imports at top, error messages to stderr)

---

## Reference Files

- **Source**: `/home/ubuntu/projects/zerg-swarm/SWARM/SCRIPTS/swarm.py` (lines 12-25)
- **Test Suite**: None (manual verification above)
- **Related**: SWARM state model defined in swarm.py load_state() default dict

---

## Notes

- This fix prevents silent failures that could lose swarm progress
- Error recovery allows swarm to restart even with corrupted state file
- State validation prevents downstream KeyError exceptions
- All error messages go to stderr, preserving stdout for command output
